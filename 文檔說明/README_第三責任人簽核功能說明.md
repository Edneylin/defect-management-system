# 第三責任人簽核功能說明

## 📋 功能概述

根據用戶需求，在原有的二級簽核流程（主要責任人→次要責任人）基礎上，新增第三責任人簽核功能。系統會根據不同的處理結果自動分配對應的第三責任人進行最終簽核。

## 🔄 簽核流程

### **三級簽核流程**
```
不良品登錄 → 主要責任人處理 → 次要責任人簽核 → 第三責任人簽核 → 完成
```

### **流程詳細說明**
1. **主要責任人處理** - 選擇處理結果並提交簽核
2. **次要責任人簽核** - 對處理結果進行確認
3. **第三責任人簽核** - 根據處理結果自動分配對應DRI進行最終簽核
4. **案件完成** - 所有簽核通過後案件結案

## 🏭 第三責任人分配規則

根據處理結果自動分配第三責任人：

| 處理結果 | 第三責任部門 | 第三責任人 | 說明 |
|---------|------------|-----------|------|
| **TRA14-報廢** | 管理部 | 廠長 | 報廢決策需要廠長最終確認 |
| **TWP12-退製二** | 製造二部 | 製造二部DRI | 退回製造二部重製需要部門DRI確認 |
| **TWP12-退製三** | 製造三部 | 製造三部DRI | 退回製造三部重製需要部門DRI確認 |
| **TWP12-轉嫁外包** | 資材部 | 資材部DRI | 外包轉嫁需要資材部DRI確認 |
| **TWP12-轉嫁供應商** | 資材部 | 資材部DRI | 供應商轉嫁需要資材部DRI確認 |
| **TRA13B-退供應商補料** | 資材部 | 資材部DRI | 供應商補料需要資材部DRI確認 |
| **TRA13A-上線重工** | 製造一部 | 製造一部DRI | 上線重工需要製造一部DRI確認 |
| **TRA11 判定後為OK品** | - | - | 不需要第三責任人簽核，直接完成 |

> **DRI (Directly Responsible Individual)**: 直接責任人，各部門指定的決策負責人

## 💻 系統功能特點

### **1. 自動分配機制**
- 系統根據處理結果自動判定是否需要第三責任人簽核
- 自動分配對應的部門和責任人
- 無需手動選擇，減少操作錯誤

### **2. 完整的簽核界面**
- **第三責任人簽核頁面**：清晰顯示前序處理結果
- **通過/退回選項**：支援最終簽核通過或退回重新處理
- **簽核備註功能**：可填寫簽核意見和備註

### **3. 狀態追蹤顯示**
- **流程狀態**：即時顯示當前簽核階段
- **第三責任人資訊**：顯示部門、責任人及簽核狀態
- **狀態標示**：
  - ⏳待簽核 - 等待第三責任人處理
  - ✅已簽核 - 第三責任人已通過
  - ❌已退回 - 第三責任人已退回

### **4. 處理記錄完整性**
- 完整記錄所有簽核動作
- 包含簽核時間、操作人員、簽核意見
- 支援完整的處理軌跡追蹤

## 📊 資料庫結構更新

### **新增欄位**
```sql
-- 第三責任人相關欄位
third_dept TEXT                -- 第三責任部門
third_person TEXT              -- 第三責任人
third_approval_status TEXT     -- 第三責任人簽核狀態
```

### **簽核狀態值**
- `待簽核` - 等待第三責任人處理
- `已簽核` - 第三責任人已通過簽核
- `已退回` - 第三責任人已退回案件

## 🔧 使用方式

### **主要責任人操作**
1. 在處理追蹤頁面選擇不良品記錄
2. 選擇適當的處理結果
3. 填寫處理備註（選填）
4. 點擊「🔄 提交簽核」

### **次要責任人操作**
1. 查看處理結果確認無誤
2. 選擇「✅ 通過」或「❌ 退回」
3. 填寫簽核備註（選填）
4. 系統自動判定是否需要第三責任人簽核

### **第三責任人操作**
1. 在處理追蹤頁面查看待簽核案件
2. 確認前序處理結果
3. 選擇「✅ 最終通過」或「❌ 退回重處理」
4. 填寫最終簽核意見（選填）

## 📈 功能優勢

### **1. 權責明確**
- 不同處理結果對應不同的最終決策者
- 避免權責不清的問題
- 確保重要決策有適當層級的確認

### **2. 流程標準化**
- 統一的三級簽核流程
- 自動化的責任人分配
- 減少人為疏失

### **3. 追蹤完整**
- 完整的簽核軌跡記錄
- 每個階段的處理時間追蹤
- 詳細的操作日誌

### **4. 彈性設計**
- 支援部分處理結果免第三責任人簽核
- 可擴展的責任人分配規則
- 向後兼容現有資料

## 🧪 測試驗證

### **測試項目**
- ✅ 處理結果與第三責任人對應關係測試
- ✅ 資料庫結構完整性測試  
- ✅ 第三責任人資訊更新測試
- ✅ 簽核流程狀態統計測試
- ✅ 測試資料清理驗證

### **測試結果**
```
🎉 所有測試通過！第三責任人簽核功能正常運作

功能說明:
1. 根據處理結果自動分配第三責任人 ✅
2. 支援七種處理結果的第三責任人簽核 ✅  
3. 完整的三級簽核流程：主要→次要→第三責任人 ✅
4. 第三責任人可以通過或退回案件 ✅
5. 完整的處理記錄追蹤 ✅
```

## 📋 實施詳情

### **實施日期**
- **開發完成**: 2025年6月18日
- **測試驗證**: 2025年6月18日  
- **功能上線**: 即時生效

### **影響範圍**
- **資料庫結構**: 新增3個欄位，向後兼容
- **簽核流程**: 擴展為三級簽核，保持原有邏輯
- **用戶界面**: 新增第三責任人簽核區域
- **處理記錄**: 增加第三責任人操作記錄

### **向後兼容性**
- ✅ 現有資料完全兼容
- ✅ 原有簽核流程保持不變
- ✅ 新功能對現有操作無影響
- ✅ 漸進式功能啟用

## 🚀 系統運行

第三責任人簽核功能現已整合到主系統中，可在以下位置訪問：

**系統地址**: http://localhost:8501  
**相關頁面**: 🔍 處理追蹤

---

## 💡 注意事項

1. **DRI設定**: 各部門需要指定對應的DRI人員
2. **權限管理**: 確保第三責任人具備適當的系統訪問權限
3. **流程培訓**: 建議對相關人員進行新流程培訓
4. **監控機制**: 建議建立第三責任人簽核的監控和提醒機制

---

*本功能實現了更完整的品質管理簽核流程，確保重要決策都有適當層級的確認，提升了整體品質管理的嚴謹性和可追溯性。* 
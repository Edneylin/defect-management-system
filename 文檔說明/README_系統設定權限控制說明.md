# 不良品管理系統 - 系統設定權限控制說明

## 📋 功能概述

本次更新為不良品管理系統的「系統設定」頁面增加了基於角色的存取權限控制，確保只有管理員和主管角色的用戶才能存取系統設定功能，提升系統安全性和管理規範性。

## 🔐 權限控制機制

### 雙重保護機制
1. **選單層級控制**：根據用戶角色動態顯示選單項目
2. **頁面層級控制**：在系統設定頁面進行二次權限驗證

### 角色權限對照表

| 角色 | 系統設定存取權限 | 用戶管理存取權限 | 其他功能權限 |
|------|------------------|------------------|--------------|
| 🔧 **管理員** | ✅ 完全存取 | ✅ 完全存取 | ✅ 所有功能 |
| 👔 **主管** | ✅ 完全存取 | ❌ 無權限 | ✅ 基本功能 |
| 🔧 **工程師** | ❌ 無權限 | ❌ 無權限 | ✅ 基本功能 |
| 👷 **操作員** | ❌ 無權限 | ❌ 無權限 | ✅ 基本功能 |

*基本功能包括：即時儀表板、不良品登錄、處理追蹤、統計分析*

## 🛡️ 安全特性

### 1. 選單動態控制
- 系統根據登入用戶的角色自動調整側邊欄選單
- 無權限的用戶無法看到「⚙️ 系統設定」選項
- 只有管理員能看到「👤 用戶管理」選項

### 2. 頁面存取驗證
- 在系統設定頁面開頭進行權限檢查
- 無權限用戶即使透過其他方式存取也會被阻擋
- 顯示友善的權限說明訊息

### 3. 用戶體驗優化
- 清楚的權限提示訊息
- 顯示當前用戶資訊
- 提供權限申請指引

## 🔧 技術實現

### 選單邏輯修改
```python
# 根據用戶角色顯示不同的功能選單
menu_options = ["📊 即時儀表板", "📋 不良品登錄", "🔍 處理追蹤", "📈 統計分析"]

# 只有管理員和主管可以看到系統設定
user_role = st.session_state.user.get('role')
if user_role in ['管理員', '主管']:
    menu_options.append("⚙️ 系統設定")

# 只有管理員可以看到用戶管理
if user_role == '管理員':
    menu_options.append("�� 用戶管理")
```

### 頁面權限檢查
```python
def settings_page():
    st.header("⚙️ 系統設定")
    
    # 權限檢查：只有管理員和主管可以存取
    user_role = st.session_state.user.get('role')
    if user_role not in ['管理員', '主管']:
        st.error("🚫 **存取權限不足**")
        st.warning(f"您的角色為「{user_role}」，無權限存取系統設定頁面。")
        return
    
    # 繼續執行系統設定功能...
```

## 📱 用戶界面變化

### 管理員登入後的選單
```
🔧 功能選單
├── 📊 即時儀表板
├── 📋 不良品登錄
├── 🔍 處理追蹤
├── 📈 統計分析
├── ⚙️ 系統設定     ← 可見
└── 👤 用戶管理     ← 可見
```

### 主管登入後的選單
```
🔧 功能選單
├── 📊 即時儀表板
├── 📋 不良品登錄
├── 🔍 處理追蹤
├── 📈 統計分析
└── ⚙️ 系統設定     ← 可見
```

### 工程師/操作員登入後的選單
```
🔧 功能選單
├── 📊 即時儀表板
├── 📋 不良品登錄
├── 🔍 處理追蹤
└── 📈 統計分析
```

## 🚫 權限拒絕頁面

當無權限用戶嘗試存取系統設定時，會看到：

```
⚙️ 系統設定

🚫 存取權限不足
⚠️ 您的角色為「工程師」，無權限存取系統設定頁面。

💡 權限說明：
• 只有「管理員」和「主管」角色可以存取系統設定
• 如需權限調整，請聯繫系統管理員

---
👤 當前登入用戶：張三 (工程部 - 工程師)
```

## 🧪 測試驗證

### 測試項目
1. ✅ **基於角色的存取控制**：驗證不同角色的權限分配
2. ✅ **選單可見性邏輯**：確認選單項目正確顯示/隱藏
3. ✅ **資料庫角色資料**：檢查用戶角色資料完整性
4. ✅ **存取場景模擬**：模擬各種存取情況

### 測試結果
- 所有測試項目通過 ✅
- 權限控制邏輯正確 ✅
- 用戶體驗友善 ✅
- 安全性符合要求 ✅

## 🔄 系統設定功能範圍

系統設定頁面包含以下功能（僅限管理員和主管存取）：

### 📧 通知設定
- 郵件通知設定
- Telegram通知設定
- 處理時限設定
- 提醒間隔設定

### 🧪 測試功能
- 發送測試郵件
- 發送測試Telegram
- 檢查逾期案件
- 查看逾期統計

### 👥 人員管理設定
- 責任人員設定
- 部門負責人管理

### 📦 產品設定
- 產品類型管理
- 產品資訊維護

## 💡 使用建議

### 管理員
- 負責整體系統設定和用戶管理
- 定期檢查通知設定是否正常
- 管理用戶角色和權限分配

### 主管
- 可以調整通知設定以符合部門需求
- 設定處理時限和提醒間隔
- 測試通知功能確保及時收到提醒

### 一般用戶
- 專注於不良品處理相關功能
- 如需調整系統設定，請聯繫管理員或主管
- 透過統計分析功能了解處理效率

## 🔧 故障排除

### 常見問題

**Q: 我是主管但看不到系統設定選項？**
A: 請檢查您的用戶角色是否正確設定為「主管」，如有問題請聯繫系統管理員。

**Q: 如何申請系統設定存取權限？**
A: 請聯繫系統管理員申請角色調整，只有管理員可以修改用戶角色。

**Q: 權限檢查是否會影響系統效能？**
A: 權限檢查邏輯非常輕量，不會對系統效能造成明顯影響。

### 技術支援
如遇到權限相關問題，請提供以下資訊：
- 用戶名稱和角色
- 嘗試存取的功能
- 錯誤訊息截圖
- 操作時間

## 📈 未來擴展

### 可能的增強功能
1. **細粒度權限控制**：針對特定功能設定更詳細的權限
2. **臨時權限授予**：允許臨時提升用戶權限
3. **操作日誌記錄**：記錄所有權限相關的操作
4. **權限申請流程**：建立權限申請和審批機制

---

## 📝 更新記錄

**版本：** 2.1.0  
**更新日期：** 2025-06-18  
**更新內容：** 新增系統設定頁面權限控制功能  
**影響範圍：** 系統設定頁面存取權限  
**測試狀態：** 已完成全面測試驗證 